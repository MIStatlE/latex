% miextras.sty — 版式与宏定义（需 XeLaTeX / LuaLaTeX）
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{miextras}[2025/08/31 MIStatlE book style]

% ==== Engine check ====
\usepackage{ifxetex,ifluatex}
\usepackage{everypage}
\ifxetex\else\ifluatex\else
  \errmessage{Please compile with XeLaTeX or LuaLaTeX}
\fi\fi

% ==== Fonts & Page ====
\usepackage{ctex,fontspec,geometry,xcolor}
\geometry{paperwidth=6in,paperheight=9in, margin=0.8in}
\setmainfont{Times New Roman}
\IfFontExistsTF{Noto Serif CJK SC}{\setCJKmainfont{Noto Serif CJK SC}}{\setCJKmainfont{FandolSong}}
\linespread{1.35}
\pagecolor{white}\color{black}

% ==== Colors ====
\definecolor{brand}{HTML}{1A9D8F}
\definecolor{brandD}{HTML}{2A7F6F}
\definecolor{ink}{HTML}{1A1A1A}
\definecolor{keybg}{HTML}{E8F4F1}
\definecolor{keydark}{HTML}{2F5E58}
\definecolor{accent}{HTML}{FF6B6B}
\definecolor{accentD}{HTML}{D94F4F}
\definecolor{soft}{HTML}{F3F8F7}

% ==== Date macro ====
\newcommand{\padzero}[1]{\ifnum#1<10 0\fi\number#1}
\newcommand{\BrandYMD}{{\the\year·\padzero{\the\month}·\padzero{\the\day}}}

% ==== Left bands on every page ====
\usepackage{tikz,eso-pic}
\usetikzlibrary{positioning,calc}
\newcommand{\LeftBandA}{0.12in}
\newcommand{\LeftBandB}{0.28in}
\newcommand{\PutLeftBands}{%
  \begin{tikzpicture}[remember picture, overlay]
    \fill[keydark] ([xshift=0cm]current page.north west)
                   rectangle ([xshift=\LeftBandA]current page.south west);
    \fill[keybg]   ([xshift=\LeftBandA]current page.north west)
                   rectangle ([xshift=\LeftBandB]current page.south west);
  \end{tikzpicture}%
}
% 兼容 AddEverypageHook
\makeatletter
\@ifundefined{AddEverypageHook}{
  \AddToShipoutPictureBG*{\PutLeftBands}
}{
  \AddEverypageHook{\PutLeftBands}
}
\makeatother

% ==== Header / Footer ====
\usepackage{fancyhdr}
\setlength{\headheight}{14pt}

\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.4pt}
% book：\leftmark=章，\rightmark=节；左右切换
\fancyhead[LE]{\nouppercase{\leftmark}}
\fancyhead[RO]{\nouppercase{\rightmark}}
\fancyfoot[LE,RO]{\textcolor{brand}{\thepage}}
\fancyfoot[LO,RE]{\textcolor{brand}{@MIStatlE｜集中不等式 \seriesnum}}

% 封面页样式（无眉脚）
\fancypagestyle{coverstyle}{
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

% 让 plain 页式 = fancy（章/部首页也有眉脚）
\fancypagestyle{plain}{
  \fancyhf{}
  \renewcommand{\headrulewidth}{0.4pt}
  \fancyhead[LE]{\nouppercase{\leftmark}}
  \fancyhead[RO]{\nouppercase{\rightmark}}
  \fancyfoot[LE,RO]{\textcolor{brand}{\thepage}}
  \fancyfoot[LO,RE]{\textcolor{brand}{@MIStatlE｜集中不等式 \seriesnum}}
}

% 目录页无眉脚（劫持 \thispagestyle）
\makeatletter
\newcommand{\TOCwithoutHeadFoot}{%
  \begingroup
    \let\saved@thispagestyle\thispagestyle
    \def\thispagestyle##1{\saved@thispagestyle{empty}}%
    \pagestyle{empty}%
    \tableofcontents
    \clearpage
  \endgroup
  \pagestyle{fancy}%
}
\makeatother

% ==== Series number parameter ====
\newcommand{\seriesnum}{I}

% ==== Titles (Part/Chapter/Section) ====
\usepackage{titlesec}
\titleformat{\part}[display]
  {\filcenter\bfseries\color{keydark}}
  {\Large Part \thepart}{0.6em}{\Huge}
  [\vspace{0.8em}{\color{brand}\rule{7cm}{1.2pt}}]
\titlespacing*{\part}{0pt}{\fill}{\fill}

\titleformat{\chapter}[display]
  {\bfseries\color{keydark}}
  {\Large 第\thechapter 章}{0.4em}{\Huge}
  [\vspace{0.4em}{\color{brandD!45}\rule{6cm}{0.8pt}}]
\titlespacing*{\chapter}{0pt}{1.2em}{0.8em}

\titleformat{\section}{\Large\bfseries\color{keydark}}{\thesection}{0.6em}{}
\titlespacing*{\section}{0pt}{0.9em}{0.5em}
\titleformat{\subsection}{\large\bfseries\color{brand}}{\thesubsection}{0.6em}{}
\titlespacing*{\subsection}{0pt}{0.8em}{0.4em}

% ==== Boxes & Sidebars ====
\usepackage[most]{tcolorbox}
\tcbset{enhanced, boxrule=0.9pt, arc=3pt, left=10pt,right=10pt,top=10pt,bottom=10pt}
\newtcolorbox{KeyBox}{
  colback=keybg, colframe=brandD,
  colbacktitle=brandD, title=\textbf{\color{white}Key Idea},
  fonttitle=\bfseries\large, coltitle=white, breakable
}
\newtcolorbox{Takeaway}{
  colback=accent!12, colframe=accentD,
  colbacktitle=accentD, title=\textbf{\color{white}Takeaway},
  fonttitle=\bfseries\large, coltitle=white, breakable
}
\definecolor{exframe}{HTML}{6C5CE7}
\definecolor{exbg}{HTML}{F2E9FF}
\newtcolorbox{Example}[1][]{%
  enhanced, colback=exbg, colframe=exframe,
  coltitle=white, colbacktitle=exframe,
  title=\textbf{Example},
  fonttitle=\bfseries, boxrule=1.1pt, arc=4pt,
  left=10pt,right=10pt,top=10pt,bottom=10pt,
  attach boxed title to top left = {yshift=-2mm, xshift=2mm},
  breakable, #1
}
\usepackage{mdframed}
\newmdenv[
  topline=false, bottomline=false, rightline=false,
  linewidth=4pt, linecolor=brand, backgroundcolor=soft,
  innerleftmargin=10pt, innerrightmargin=10pt,
  skipabove=6pt, skipbelow=6pt
]{SideBar}

% ==== Math & Theorems ====
\usepackage{amsmath,amssymb,bm,amsthm}
\DeclareMathOperator{\Var}{Var}
\newcommand{\E}{\mathbb{E}}
\numberwithin{equation}{chapter}
\theoremstyle{plain}
\newtheorem{theorem}{定理}[chapter]
\newtheorem{lemma}[theorem]{引理}
\newtheorem{proposition}[theorem]{命题}
\newtheorem{corollary}[theorem]{推论}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{定义}
\theoremstyle{remark}
\newtheorem{remark}[theorem]{注释}

% ==== Simple Cover Macro ====
\newcommand{\MakeBookCoverUltraSimple}[3]{%
  \thispagestyle{coverstyle}%
  \vspace*{\fill}
  \begin{center}
    {\bfseries\fontsize{30}{36}\selectfont\color{keydark} #1\par}
    \vspace{0.45em}
    {\bfseries\fontsize{16}{22}\selectfont\color{ink!90} #2\par}
    \vspace{0.6em}
    \if\relax\detokenize{#3}\relax\else
      \vspace{0.2em}
      {\color{brandD}\fboxsep=6pt\colorbox{white}{\textbf{\textcolor{brandD}{#3}}}\par}
    \fi
    \vspace{0.8em}
    {\small\color{keydark!75}\BrandYMD}
  \end{center}
  \vspace*{\fill}
  \clearpage
}

% ==== Chapter Epigraph ====
\newcommand{\ChapterEpigraph}[2][]{%
  \par\vspace*{0.6em}
  \begin{flushright}
    \begin{minipage}{0.78\linewidth}\raggedleft
      {\itshape\color{ink!85}#2\par}%
      \if\relax\detokenize{#1}\relax\else
        \vspace{0.3em}{\color{ink!70}--- #1}\par
      \fi
    \end{minipage}
  \end{flushright}
  \vspace{0.6em}
}